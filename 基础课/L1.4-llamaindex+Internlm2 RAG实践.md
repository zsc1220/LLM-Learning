# llamaindex+Internlm2 RAGå®è·µ
å‚è€ƒå­¦ä¹ èµ„æ–™ï¼šhttps://github.com/InternLM/Tutorial/tree/camp3/docs/L1/LlamaIndex

## 1 æ£€ç´¢å¢å¼ºç”ŸæˆRAGï¼ˆRetrieval Augmented Generationï¼‰
### 1.1 RAGæŠ€æœ¯æ¦‚è¿°
RAGæŠ€æœ¯æ˜¯æ ¹æ®é—®é¢˜ä»çŸ¥è¯†åº“ä¸­æ£€ç´¢èƒŒæ™¯çŸ¥è¯†ï¼Œä»¥è¾…åŠ©å¤§è¯­è¨€æ¨¡å‹ç”Ÿæˆç­”æ¡ˆã€‚RAGå…è®¸å¯¹æ–°å¢æ•°æ®éƒ¨åˆ†ä½¿ç”¨ç›¸åŒçš„æ¨¡å‹å¤„ç†ï¼Œè€Œæ— éœ€è°ƒæ•´åŠå¾®è°ƒæ¨¡å‹ï¼Œä»è€Œæå¤§åœ°æ‹“å±•äº†å¤§æ¨¡å‹çš„å¯ç”¨æ€§ã€‚åŒæ—¶RAGå¯ä»¥ä¿æŠ¤ç”¨æˆ·çš„ç§åŸŸæ•°æ®ï¼Œé¿å…æ•°æ®å¤–æ³„ã€‚
![alt text](img4/RAGæŠ€æœ¯æ¦‚è¿°.png)
ä¸»è¦è§£å†³å¤§æ¨¡å‹å½“å‰çš„ä¸€äº›å±€é™æ€§:
- å¹»è§‰é—®é¢˜ï¼šLLM æ–‡æœ¬ç”Ÿæˆçš„åº•å±‚åŸç†æ˜¯åŸºäºæ¦‚ç‡çš„ token by token çš„å½¢å¼ï¼Œå› æ­¤ä¼šä¸å¯é¿å…åœ°äº§ç”Ÿâ€œä¸€æœ¬æ­£ç»çš„èƒ¡è¯´å…«é“â€çš„æƒ…å†µã€‚
- å‚åŸŸçŸ¥è¯†ä¸è¶³ï¼šå¤§æ¨¡å‹é€šè¿‡é¢„è®­ç»ƒè·å¾—é€šç”¨è¯­è¨€èƒ½åŠ›ï¼Œä½†ä¸å…·å¤‡ä¸“ä¸šé¢†åŸŸçš„çŸ¥è¯†ã€‚å¯¹æŸäº›ä¸“ä¸šé—®é¢˜æ— æ³•åšå‡ºå‡†ç¡®å›ç­”ã€‚
- è®°å¿†åŠ›æœ‰é™ï¼šå¤§è¯­è¨€æ¨¡å‹å‚æ•°é‡è™½ç„¶å¾ˆå¤§ï¼Œä½†ä»ç„¶æ— æ³•è®°ä½å¤§é‡å…·ä½“çš„äº‹å®çŸ¥è¯†ã€‚å®¹æ˜“åœ¨éœ€è¦è®°å¿†çš„ä»»åŠ¡ä¸Šè¡¨ç°ä¸ä½³ã€‚
- æ—¶æ•ˆæ€§é—®é¢˜ï¼šå¤§è¯­è¨€æ¨¡å‹çš„è§„æ¨¡è¶Šå¤§ï¼Œå¤§æ¨¡å‹è®­ç»ƒçš„æˆæœ¬è¶Šé«˜ï¼Œå‘¨æœŸä¹Ÿå°±è¶Šé•¿ã€‚é‚£ä¹ˆå…·æœ‰æ—¶æ•ˆæ€§çš„æ•°æ®ä¹Ÿå°±æ— æ³•å‚ä¸è®­ç»ƒï¼Œæ‰€ä»¥ä¹Ÿå°±æ— æ³•ç›´æ¥å›ç­”æ—¶æ•ˆæ€§ç›¸å…³çš„é—®é¢˜ï¼Œä¾‹å¦‚â€œå¸®æˆ‘æ¨èå‡ éƒ¨çƒ­æ˜ çš„ç”µå½±ï¼Ÿâ€ã€‚
- æ•°æ®å®‰å…¨é—®é¢˜ï¼šé€šç”¨å¤§è¯­è¨€æ¨¡å‹æ²¡æœ‰ä¼ä¸šå†…éƒ¨æ•°æ®å’Œç”¨æˆ·æ•°æ®ï¼Œé‚£ä¹ˆä¼ä¸šæƒ³è¦åœ¨ä¿è¯å®‰å…¨çš„å‰æä¸‹ä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹ï¼Œæœ€å¥½çš„æ–¹å¼å°±æ˜¯æŠŠæ•°æ®å…¨éƒ¨æ”¾åœ¨æœ¬åœ°ï¼Œä¼ä¸šæ•°æ®çš„ä¸šåŠ¡è®¡ç®—å…¨éƒ¨åœ¨æœ¬åœ°å®Œæˆã€‚è€Œåœ¨çº¿çš„å¤§æ¨¡å‹ä»…ä»…å®Œæˆä¸€ä¸ªå½’çº³çš„åŠŸèƒ½  
  
RAGæŠ€æœ¯çš„å‘å±•è¿›ç¨‹ï¼š
![alt text](img4/RAGæŠ€æœ¯çš„å‘å±•è¿›ç¨‹.png)

### 1.2 RAGå·¥ä½œåŸç†
![alt text](img4/RAGå·¥ä½œåŸç†.png)
![alt text](img4/å‘é‡æ•°æ®åº“.png)

### 1.3 RAGå®Œæ•´æµç¨‹
RAG çš„åŸºæœ¬æ“ä½œæµç¨‹ï¼š
>ç¦»çº¿æ­¥éª¤ï¼šæ–‡æ¡£åŠ è½½->åˆ‡åˆ†->å‘é‡åŒ–->çŒåº“  
åœ¨çº¿æ­¥éª¤ï¼šé—®é¢˜->å‘é‡åŒ–->æ£€ç´¢->Promptâ†’LLMâ†’å›å¤
![alt text](img4/RAGå®Œæ•´æµç¨‹.png)

### 1.4 RAGä¼˜åŒ–
![alt text](img4/RAGå¸¸è§ä¼˜åŒ–æ–¹æ³•.png)
1. Promptä¼˜åŒ–  
promptå¾ˆé‡è¦ï¼ŒåŒä¸€ä¸ªè¯­ä¹‰ï¼Œç”¨è¯ä¸åŒï¼Œå¯èƒ½å¯¼è‡´æ£€ç´¢ä¸åˆ°æœ‰æ•ˆçš„ç»“æœã€‚
2. Embeddingæ¨¡å‹å¾®è°ƒ  
å¼€æºå•†ä¸šembeddingæ¨¡å‹åŸºäºé€šç”¨è¯­æ–™è®­ç»ƒï¼Œå¯¹ç§åŸŸæ•°æ®é€šå¸¸è¡¨ç°ä¸ä½³ï¼Œå¾®è°ƒembeddingæ¨¡å‹æ˜¯ä¸€ç§éå¸¸ç»æµçš„RAGè¡¨ç°å¢å¼ºæ–¹æ¡ˆã€‚
3. Rerankeræ¨¡å‹  
embeddingæ¨¡å‹è™½èƒ½å¤Ÿåœ¨ç»™å®šçš„top_kå†…å¬å›æ–‡æœ¬å—ï¼Œä½†ç›®æ ‡æ–‡æœ¬å—çš„ä½ç½®å¹¶étop1ï¼Œå¯¼è‡´ç»„ç»‡ä¸ºpromptæ—¶ï¼Œç›®æ ‡æ–‡æœ¬å¤„äºå®Œæ•´promptçš„ä¸­é—´ä½ç½®ã€‚  
é€šè¿‡Rerankeræ¨¡å‹å¯ä»¥å¯¹å¬å›æ–‡æ¡£è¿›è¡Œé‡æ’ï¼Œè·å¾—æ›´ç²¾ç»†çš„ç›¸å…³æ€§å¾—åˆ†ï¼Œä»è€Œä½¿ç›®æ ‡æ–‡æ¡£çš„ä½ç½®é å‰ã€‚
4. å¤šè·¯å¬å›  
- é’ˆå¯¹ä¸åŒçš„æ•°æ®æºè¿›è¡Œæ£€ç´¢ï¼Œå¦‚æ–‡æœ¬å…³é”®å­—æ£€ç´¢ã€å‘é‡æ£€ç´¢ã€æœç´¢å¼•æ“æ£€ç´¢ã€å›¾æ•°æ®åº“æ£€ç´¢ã€å…³ç³»æ•°æ®åº“æ£€ç´¢ï¼Œå°†æ£€ç´¢çš„ç»“æœè¿›è¡Œé‡æ’ã€‚
- å¤šè·¯å¬å›å¯ä»¥æœ‰æ•ˆä¸°å¯Œpromptçš„äº‹å®æ€§å’Œå¤šæ ·æ€§ï¼Œé™ä½å¹»è§‰çš„å¯èƒ½æ€§ï¼Œä½†å¯¹promptæ¨¡æ¿çš„è´¨é‡ã€å¤§æ¨¡å‹çš„æ¨ç†èƒ½åŠ›å’Œé‡æ’ç®—æ³•çš„æ•ˆæœæå‡ºäº†æ›´é«˜çš„è¦æ±‚ã€‚
- æ–‡æœ¬å…³é”®å­—æ£€ç´¢ã€å‘é‡æ£€ç´¢ã€æœç´¢å¼•æ“æ£€ç´¢ä¸»è¦ç“¶é¢ˆåœ¨é‡æ’ç®—æ³•çš„æ•ˆæœï¼Œè€Œå›¾æ•°æ®åº“æ£€ç´¢ã€å…³ç³»æ•°æ®åº“æ£€ç´¢åˆ™éå¸¸ä¾èµ–å¤§æ¨¡å‹çš„ä»£ç ç”Ÿæˆèƒ½åŠ›ã€‚
5. å…ƒæ•°æ®æ ‡æ³¨  
meta-data:åœ¨è¢«æ£€ç´¢æ•°æ®ä¸­åŠ å…¥æ ‡é¢˜ã€é¡µç ã€æ—¥æœŸç­‰meta-dataå¯ä»¥æ‰§è¡Œè¿›ä¸€æ­¥çš„è¿‡æ»¤ï¼Œæé«˜å¬å›æ•°æ®çš„ç²¾å‡†åº¦ã€‚æ ¹æ®æ¯å—åˆ†å—æ•°æ®æå–æ‘˜è¦æ•°æ®å½“ä½œå…ƒæ•°æ®æŸ¥è¯¢ã€‚

### 1.5 RAG VS å¾®è°ƒï¼ˆFine-tuningï¼‰
![alt text](img4/RAGä¸å¾®è°ƒå¯¹æ¯”.png)
LLMå¤§æ¨¡å‹ä¼˜åŒ–æ–¹æ³•æ¯”è¾ƒï¼š
![alt text](img4/LLMå¤§æ¨¡å‹ä¼˜åŒ–æ–¹æ³•æ¯”è¾ƒ.png)

### 1.5 RAGè¯„ä¼°æ¡†æ¶å’ŒåŸºå‡†æµ‹è¯•
![alt text](img4/RAGè¯„ä¼°æ¡†æ¶å’ŒåŸºå‡†æµ‹è¯•.png)

## 2 LlamaIndex
LlamaIndex æ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡å¢å¼ºçš„ LLM æ¡†æ¶ï¼Œæ—¨åœ¨é€šè¿‡å°†å…¶ä¸ç‰¹å®šä¸Šä¸‹æ–‡æ•°æ®é›†é›†æˆï¼Œå¢å¼ºå¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMsï¼‰çš„èƒ½åŠ›ã€‚å®ƒå…è®¸æ‚¨æ„å»ºåº”ç”¨ç¨‹åºï¼Œæ—¢åˆ©ç”¨ LLMs çš„ä¼˜åŠ¿ï¼Œåˆèå…¥æ‚¨çš„ç§æœ‰æˆ–é¢†åŸŸç‰¹å®šä¿¡æ¯ã€‚
![alt text](img4/LlamaIndex.png)
### 2.1 LlamaIndexç‰¹ç‚¹
![alt text](img4/LlamaIndexç‰¹ç‚¹.png)

### 2.2 LlamaIndex-RAGåº”ç”¨
![alt text](img4/LlamaIndex-RAGåº”ç”¨.png)

## 3 å®æˆ˜
### 3.1 åŸºç¡€ç¯å¢ƒå‡†å¤‡
- åˆ›å»ºå¼€å‘æœºï¼š30% A100 * 1 ã€ Cuda11.7-conda é•œåƒ
æˆ‘ä»¬å¤ç”¨ä¸ŠèŠ‚è¯¾çš„ç¯å¢ƒ
```bash
conda activate langgpt

# å®‰è£…python ä¾èµ–åŒ…
pip install einops protobuf

# å®‰è£… Llamaindex
pip install llama-index==0.10.38 llama-index-llms-huggingface==0.2.0 "transformers[torch]==4.41.1" "huggingface_hub[inference]==0.23.1" huggingface_hub==0.23.1 sentence-transformers==2.7.0 sentencepiece==0.2.0
```

### 3.2 ä¸‹è½½ Sentence Transformer æ¨¡å‹
æœ¬æ¬¡å®éªŒé€‰æ‹©çš„å¼€æºè¯å‘é‡æ¨¡å‹æ˜¯[Sentence Transformer](https://huggingface.co/sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2)ã€‚
```bash
# æ–°å»ºä¸‹è½½è„šæœ¬æ–‡ä»¶
cd /root/dev
touch download_hf_sentence.py
```
è´´å…¥ä»¥ä¸‹ä»£ç :
```python
import os

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæ›´å¤šå…³äºé•œåƒä½¿ç”¨å¯ä»¥ç§»æ­¥è‡³https://hf-mirror.com/æŸ¥çœ‹ã€‚
os.environ['HF_ENDPOINT'] = 'https://hf-mirror.com'

# ä¸‹è½½æ¨¡å‹
os.system('huggingface-cli download --resume-download sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2 --local-dir /root/model/sentence-transformer')
```
æ‰§è¡Œè„šæœ¬python download_hf_sentence.py ä¸‹è½½æ¨¡å‹ã€‚

### 3.3 ä¸‹è½½ NLTK ç›¸å…³èµ„æº
æˆ‘ä»¬åœ¨ä½¿ç”¨å¼€æºè¯å‘é‡æ¨¡å‹æ„å»ºå¼€æºè¯å‘é‡çš„æ—¶å€™ï¼Œéœ€è¦ç”¨åˆ°ç¬¬ä¸‰æ–¹åº“ nltk çš„ä¸€äº›èµ„æºã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œå…¶ä¼šè‡ªåŠ¨ä»äº’è”ç½‘ä¸Šä¸‹è½½ï¼Œä½†å¯èƒ½ç”±äºç½‘ç»œåŸå› ä¼šå¯¼è‡´ä¸‹è½½ä¸­æ–­ï¼Œæ­¤å¤„æˆ‘ä»¬å¯ä»¥ä»å›½å†…ä»“åº“é•œåƒåœ°å€ä¸‹è½½ç›¸å…³èµ„æºï¼Œä¿å­˜åˆ°æœåŠ¡å™¨ä¸Šã€‚ æˆ‘ä»¬ç”¨ä»¥ä¸‹å‘½ä»¤ä¸‹è½½ nltk èµ„æºå¹¶è§£å‹åˆ°æœåŠ¡å™¨ä¸Šï¼š
```bash
cd /root/code
git clone https://gitee.com/yzy0612/nltk_data.git  --branch gh-pages
cd nltk_data
mv packages/*  ./
cd tokenizers
unzip punkt.zip
cd ../taggers
unzip averaged_perceptron_tagger.zip
```

### 3.4 LlamaIndex HuggingFaceLLM
è¿è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼ŒæŠŠ InternLM2 1.8B è½¯è¿æ¥å‡ºæ¥:
```bash
ln -s /root/share/new_models/Shanghai_AI_Laboratory/internlm2-chat-1_8b /root/model/Shanghai_AI_Laboratory/internlm2-chat-1_8b
```
åœ¨/root/dev/llamaindexç›®å½•ä¸‹ï¼Œæ–°å»ºæ–‡ä»¶llamaindex_internlm.py è´´å…¥ä»¥ä¸‹ä»£ç ï¼š
```python
from llama_index.llms.huggingface import HuggingFaceLLM
from llama_index.core.llms import ChatMessage
llm = HuggingFaceLLM(
    model_name="/root/model/Shanghai_AI_Laboratory/internlm2-chat-1_8b/",
    tokenizer_name="/root/model/Shanghai_AI_Laboratory/internlm2-chat-1_8b",
    model_kwargs={"trust_remote_code":True},
    tokenizer_kwargs={"trust_remote_code":True}
)

rsp = llm.chat(messages=[ChatMessage(content="xtuneræ˜¯ä»€ä¹ˆï¼Ÿ")])
print(rsp)
```
è¿è¡Œè¯¥è„šæœ¬ï¼Œç»“æœä¸ºï¼š
![alt text](img4/xtuneræ˜¯ä»€ä¹ˆçš„é—®é¢˜å›ç­”.png)

é—®é¢˜å˜æ›´ä¸ºï¼šâ€œã€Šäººä¿å¯¿é™©äººä¿ç¦ç»ˆèº«å¯¿é™©ã€‹çš„è´£ä»»å…é™¤é¡¹æœ‰å“ªäº›ï¼Ÿâ€ï¼Œç»“æœä¸ºï¼š
![alt text](img4/ã€Šäººä¿å¯¿é™©äººä¿ç¦ç»ˆèº«å¯¿é™©ã€‹çš„è´£ä»»å…é™¤é¡¹æœ‰å“ªäº›-LLMç›´æ¥å›ç­”.png)
å›ç­”å­˜åœ¨å¹»è§‰ï¼Œä¸æ˜¯[äººä¿å¯¿é™©äººä¿ç¦ç»ˆèº«å¯¿é™©](https://www.picclife.com/picclifewebsite/webfile/upload/2023/05-16/17-26-430017-1437008262.pdf)çš„è´£ä»»å…é™¤é¡¹ã€‚

### 3.5 LlamaIndex RAG
å®‰è£… LlamaIndex è¯åµŒå…¥å‘é‡ä¾èµ–
```bash
pip install llama-index-embeddings-huggingface llama-index-embeddings-instructor
```
ä¸‹è½½pdfæ–‡ä»¶[äººä¿å¯¿é™©äººä¿ç¦ç»ˆèº«å¯¿é™©.PDF](https://www.picclife.com/picclifewebsite/webfile/upload/2023/05-16/17-26-430017-1437008262.pdf)åˆ°ç›®å½•/root/dev/dataä¸‹ã€‚  
åœ¨/root/dev/llamaindexç›®å½•ä¸‹ï¼Œæ–°å»ºæ–‡ä»¶llamaindex_RAG.py è´´å…¥ä»¥ä¸‹ä»£ç ï¼š
```python
from llama_index.core import VectorStoreIndex, SimpleDirectoryReader, Settings

from llama_index.embeddings.huggingface import HuggingFaceEmbedding
from llama_index.llms.huggingface import HuggingFaceLLM

#åˆå§‹åŒ–ä¸€ä¸ªHuggingFaceEmbeddingå¯¹è±¡ï¼Œç”¨äºå°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡è¡¨ç¤º
embed_model = HuggingFaceEmbedding(
#æŒ‡å®šäº†ä¸€ä¸ªé¢„è®­ç»ƒçš„sentence-transformeræ¨¡å‹çš„è·¯å¾„
    model_name="/root/model/sentence-transformer"
)
#å°†åˆ›å»ºçš„åµŒå…¥æ¨¡å‹èµ‹å€¼ç»™å…¨å±€è®¾ç½®çš„embed_modelå±æ€§ï¼Œ
#è¿™æ ·åœ¨åç»­çš„ç´¢å¼•æ„å»ºè¿‡ç¨‹ä¸­å°±ä¼šä½¿ç”¨è¿™ä¸ªæ¨¡å‹ã€‚
Settings.embed_model = embed_model

llm = HuggingFaceLLM(
    model_name="/root/model/Shanghai_AI_Laboratory/internlm2-chat-1_8b",
    tokenizer_name="/root/model/Shanghai_AI_Laboratory/internlm2-chat-1_8b",
    model_kwargs={"trust_remote_code":True},
    tokenizer_kwargs={"trust_remote_code":True}
)
#è®¾ç½®å…¨å±€çš„llmå±æ€§ï¼Œè¿™æ ·åœ¨ç´¢å¼•æŸ¥è¯¢æ—¶ä¼šä½¿ç”¨è¿™ä¸ªæ¨¡å‹ã€‚
Settings.llm = llm

#ä»æŒ‡å®šç›®å½•è¯»å–æ‰€æœ‰æ–‡æ¡£ï¼Œå¹¶åŠ è½½æ•°æ®åˆ°å†…å­˜ä¸­
documents = SimpleDirectoryReader("/root/dev/data").load_data(show_progress=True)
#åˆ›å»ºä¸€ä¸ªVectorStoreIndexï¼Œå¹¶ä½¿ç”¨ä¹‹å‰åŠ è½½çš„æ–‡æ¡£æ¥æ„å»ºç´¢å¼•ã€‚
# æ­¤ç´¢å¼•å°†æ–‡æ¡£è½¬æ¢ä¸ºå‘é‡ï¼Œå¹¶å­˜å‚¨è¿™äº›å‘é‡ä»¥ä¾¿äºå¿«é€Ÿæ£€ç´¢ã€‚
index = VectorStoreIndex.from_documents(documents)
# åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢å¼•æ“ï¼Œè¿™ä¸ªå¼•æ“å¯ä»¥æ¥æ”¶æŸ¥è¯¢å¹¶è¿”å›ç›¸å…³æ–‡æ¡£çš„å“åº”ã€‚
query_engine = index.as_query_engine()
response = query_engine.query("ã€Šäººä¿å¯¿é™©äººä¿ç¦ç»ˆèº«å¯¿é™©ã€‹çš„è´£ä»»å…é™¤é¡¹æœ‰å“ªäº›ï¼Ÿ")

print(response)
```
è¿è¡Œè¯¥è„šæœ¬ï¼Œç»“æœä»ç„¶ä¸ç†æƒ³ï¼š

é—®ï¼šâ€ã€Šäººä¿å¯¿é™©äººä¿ç¦ç»ˆèº«å¯¿é™©ã€‹ä¸­çš„èº«æ•…ä¿é™©é‡‘ç”³è¯·çš„å†…å®¹æ˜¯ä»€ä¹ˆâ€œï¼Œç»“æœä¸ºï¼š
![alt text](img4/ä¼˜åŒ–æç¤ºè¯åçš„å›ç­”.png)
æ–‡ä»¶å†…å®¹æ¯”è¾ƒå¤æ‚çš„åœºæ™¯ï¼Œéœ€è¦ä¼˜åŒ–æç¤ºè¯ï¼Œå¦åˆ™ç»“æœå¯èƒ½ä¸å‡†ç¡®ï¼ŒåŒæ—¶éœ€è¦å‡çº§åŸºç¡€æ¨¡å‹ã€‚

### 3.6 LlamaIndex web
æ–°å»ºä¸€ä¸ªpythonæ–‡ä»¶llama_index_web_demo.pyï¼Œè´´å…¥ä»¥ä¸‹ä»£ç ï¼š
```python
import streamlit as st
from llama_index.core import VectorStoreIndex, SimpleDirectoryReader, Settings
from llama_index.embeddings.huggingface import HuggingFaceEmbedding
from llama_index.llms.huggingface import HuggingFaceLLM

st.set_page_config(page_title="llama_index_web_demo", page_icon="ğŸ¦œğŸ”—")
st.title("llama_index_web_demo")

# åˆå§‹åŒ–æ¨¡å‹
@st.cache_resource
def init_models():
    embed_model = HuggingFaceEmbedding(
        model_name="/root/model/sentence-transformer"
    )
    Settings.embed_model = embed_model

    llm = HuggingFaceLLM(
        model_name="/root/model/Shanghai_AI_Laboratory/internlm2-chat-1_8b",
        tokenizer_name="/root/model/Shanghai_AI_Laboratory/internlm2-chat-1_8b",
        model_kwargs={"trust_remote_code": True},
        tokenizer_kwargs={"trust_remote_code": True}
    )
    Settings.llm = llm

    documents = SimpleDirectoryReader("/root/dev/data").load_data(show_progress=True)
    index = VectorStoreIndex.from_documents(documents)
    query_engine = index.as_query_engine()

    return query_engine

# æ£€æŸ¥æ˜¯å¦éœ€è¦åˆå§‹åŒ–æ¨¡å‹
if 'query_engine' not in st.session_state:
    st.session_state['query_engine'] = init_models()

def greet2(question):
    response = st.session_state['query_engine'].query(question)
    return response

      
# Store LLM generated responses
if "messages" not in st.session_state.keys():
    st.session_state.messages = [{"role": "assistant", "content": "ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ"}]    

    # Display or clear chat messages
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.write(message["content"])

def clear_chat_history():
    st.session_state.messages = [{"role": "assistant", "content": "ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ"}]

st.sidebar.button('Clear Chat History', on_click=clear_chat_history)

# Function for generating LLaMA2 response
def generate_llama_index_response(prompt_input):
    return greet2(prompt_input)

# User-provided prompt
if prompt := st.chat_input():
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.write(prompt)

# Gegenerate_llama_index_response last message is not from assistant
if st.session_state.messages[-1]["role"] != "assistant":
    with st.chat_message("assistant"):
        with st.spinner("Thinking..."):
            response = generate_llama_index_response(prompt)
            placeholder = st.empty()
            placeholder.markdown(response)
    message = {"role": "assistant", "content": response}
    st.session_state.messages.append(message)
```
é€šè¿‡streamlitè¿è¡Œwebuiï¼š
```bash
streamlit run llama_index_web_demo.py
```
å°†ç«¯å£æ˜ å°„åˆ°æœ¬åœ°(æœ¬åœ°ç»ˆç«¯è¿è¡Œ ssh -CNg -L 8501:127.0.0.1:8501 root@ssh.intern-ai.org.cn -p 48466  )ã€‚åœ¨æœ¬åœ°æµè§ˆå™¨è¾“å…¥ http://127.0.0.1:8501/ å³å¯ã€‚
![alt text](img4/llama_index_webui.png)

## 4 ä½œä¸š - åŸºç¡€ä»»åŠ¡
ä»»åŠ¡è¦æ±‚ï¼šåŸºäº LlamaIndex æ„å»ºè‡ªå·±çš„ RAG çŸ¥è¯†åº“ï¼Œå¯»æ‰¾ä¸€ä¸ªé—®é¢˜ A åœ¨ä½¿ç”¨ LlamaIndex ä¹‹å‰InternLM2-Chat-1.8Bæ¨¡å‹ä¸ä¼šå›ç­”ï¼Œå€ŸåŠ© LlamaIndex å InternLM2-Chat-1.8B æ¨¡å‹å…·å¤‡å›ç­” A çš„èƒ½åŠ›ï¼Œæˆªå›¾ä¿å­˜ã€‚

## 4.1 è¯¦ç»†è¿‡ç¨‹å‚è§ç¬¬ä¸‰ç« èŠ‚
é—®é¢˜æ˜¯ï¼šâ€œã€Šäººä¿å¯¿é™©äººä¿ç¦ç»ˆèº«å¯¿é™©ã€‹ä¸­çš„èº«æ•…ä¿é™©é‡‘ç”³è¯·çš„å†…å®¹æ˜¯ä»€ä¹ˆâ€
ç›´æ¥é—®å¤§æ¨¡å‹çš„å›ç­”ï¼š
![alt text](img4/èº«æ•…ä¿é™©é‡‘ç”³è¯·çš„å†…å®¹æ˜¯ä»€ä¹ˆçš„å›ç­”.png)
é€šè¿‡RAGå¢å¼ºåçš„å›ç­”ï¼š
![alt text](img4/ä¼˜åŒ–æç¤ºè¯åçš„å›ç­”.png)

